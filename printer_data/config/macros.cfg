[gcode_macro CALIBRAR_TAKUYA]
gcode:
    G28                         # Home completo
    G90
    ATTACH_PROBE                
    # Nos movemos a Y40. Al sumar el offset de 22, la sonda medirá en Y62.
    # 62 es menor que 120, por lo que NO dará error.
    G0 X60 Y40 Z10 F6000        
    
    M118 "Midiendo referencia en punto seguro..."
    _PROBE_CALIBRATE            
    
    G0 Z20 F600
    DOCK_PROBE                  
    G0 X60 Y60 Z15 F6000        
    M118 "LISTO. Baja el nozzle con TESTZ Z=-1"

#####################################################################
#   PRINT_START Pandora (Sin Heat Soak)
#####################################################################

[gcode_macro PRINT_START]
gcode:
  # Parámetros del Slicer
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  CLEAR_PAUSE
  BED_MESH_CLEAR                # Limpia mallas viejas
  G90                           # Coordenadas absolutas
  STATUS_HOMING
  G28                           # Home completo (XYZ) usando el Klicky

  # 1. Calentamiento inicial de la cama
  SET_DISPLAY_TEXT MSG="Calentando cama: {target_bed}c"
  STATUS_HEATING
  G1 X{x_wait} Y{y_wait} Z15 F9000
  M190 S{target_bed}

  # 2. Precalentar hotend a 150c para limpieza/dilatación
  SET_DISPLAY_TEXT MSG="Precalentar hotend: 150c"
  M109 S150

  # 3. Nivelación y Malla Adaptativa (KAMP)
  SET_DISPLAY_TEXT MSG="Z-Tilt Adjust"
  STATUS_LEVELING
  Z_TILT_ADJUST                 # Nivela los motores Z
  G28 Z                         # Re-Home Z tras nivelar

  SET_DISPLAY_TEXT MSG="Bed Mesh Adaptativo"
  STATUS_MESHING
  BED_MESH_CALIBRATE ADAPTIVE=1 # Solo mide el área de la pieza

  # 4. Smart Park (KAMP) - Se posiciona cerca de la pieza para calentar
  SET_DISPLAY_TEXT MSG="Smart Park"
  SMART_PARK                    # Aparca cerca de la zona de impresión

  # 5. Calentamiento Final
  SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"
  STATUS_HEATING
  M109 S{target_extruder}       # Espera temperatura final

  # 6. Purga Adaptativa (KAMP)
  SET_DISPLAY_TEXT MSG="Line Purge"
  LINE_PURGE                    # Purga inteligente según el objeto

  SET_DISPLAY_TEXT MSG="Imprimiendo..."
  STATUS_PRINTING

[gcode_macro PRINT_END]
gcode:
    # 1. Esperar a que terminen los movimientos y retraer filamento
    M400                           # Esperar a que el buffer de movimientos esté vacío
    G92 E0                         # Reset extrusor
    G1 E-5.0 F3600                 # Retraer 5mm de filamento para evitar goteo
    
    # 2. Apagar calentadores y ventiladores
    TURN_OFF_HEATERS
    M107                           # Apagar ventilador de capa
    
    # 3. Movimiento de seguridad (Levantar y retirar)
    G91                            # Modo relativo
    # Levanta 10mm o hasta el máximo de la impresora para no chocar arriba
    G1 Z10 F3000                   
    
    G90                            # Modo absoluto
    # Retirar cabezal a la esquina trasera para liberar la pieza (X110 Y110)
    G1 X110 Y110 F10000            

    # 4. Limpieza final
    BED_MESH_CLEAR                 # Borrar la malla de la cama
    SET_GCODE_OFFSET Z=0           # Resetear cualquier ajuste de Z temporal
    
    M117 Impresion Finalizada.
    STATUS_READY                   # Si tienes LEDs, los pone en modo reposo

    #####################################################################
# Carga y Descarga de Filamento (Load/Unload)
#####################################################################

[gcode_macro LOAD_FILAMENT]
gcode:
   {% set speed = printer.configfile.settings.extruder.max_extrude_only_velocity %}
   SAVE_GCODE_STATE NAME=load_state
   G91                         # Posicionamiento relativo
   G92 E0                      # Reset extrusor
   G1 E50 F{speed}             # Carga rápida (50mm)
   G1 E50 F300                 # Extrusión lenta para purgar (50mm)
   G92 E0
   RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
gcode:
   {% set speed = printer.configfile.settings.extruder.max_extrude_only_velocity %}
   SAVE_GCODE_STATE NAME=unload_state
   G91                         # Posicionamiento relativo
   G92 E0                      # Reset extrusor
   G1 E10 F300                 # Extruye un poco para limpiar la punta
   G1 E-10 F{speed}            # Retracción rápida inicial
   G1 E-80 F{speed}            # Retracción larga para sacar el filamento (ajusta si es necesario)
   G92 E0
   RESTORE_GCODE_STATE NAME=unload_state